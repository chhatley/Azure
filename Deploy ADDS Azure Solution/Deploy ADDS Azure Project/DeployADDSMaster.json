{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "DomainName": {
      "type": "string",
      "metadata": {
        "description": "Please enter you Active Directory domain name."
      },
      "defaultValue": "dc3n.navy.mil"
    },
    "AdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the Administrator of the new VMs and Domain"
      },
      "defaultValue": "labadmin"
    },
    "AdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Administrator account of the new VMs and Domain. By default, the password will be: NavySUBSCRIPTIONID"
      },
      "defaultValue": "[concat('Navy',subscription().subscriptionId)]"
    },
    "SourceClientIP": {
      "type": "string",
      "metadata": {
        "description": "Public IP of the computer that can RDP into this lab.  Find the public IP or subnet for your device to lock down access to your environment or change this to * to allow all Internet devices access you environment lab or find out external IP or subnet for your device to lock down access to your lab from the Internet."
      },
      "defaultValue": "127.0.0.1"
    },
    "DC1 Hostname": {
      "type": "string",
      "defaultValue": "T0-DC3N-01"
    },
    "DC2 Hostname": {
      "type": "string",
      "defaultValue": "T0-DC3N-02"
    },
    "T0 Jump Server Hostname": {
      "type": "string",
      "defaultValue": "T0-AD-JS-01"
    },
    "T0 Public Load Balancer Name": {
      "type": "string",
      "defaultValue": "T0-AD-JS-LB-01"
    },
    "T0 AD vNet Name": {
      "type": "string",
      "defaultValue": "T0-AD-vNet-01"
    },
    "T0 AD Availability Set Name": {
      "type": "string",
      "defaultValue": "T0-AD-AS-01"
    },
    "DC1VMImageSKU": {
      "type": "string",
      "allowedValues": [
        "2012-R2-Datacenter",
        "2016-Datacenter",
        "2019-Datacenter"
      ],
      "metadata": {
        "description": "Choose the OS type for the first domain controller."
      },
      "defaultValue": "2019-Datacenter"
    },
    "DC2VMImageSKU": {
      "type": "string",
      "allowedValues": [
        "2012-R2-Datacenter",
        "2016-Datacenter",
        "2019-Datacenter"
      ],
      "metadata": {
        "description": "Choose the OS type for the second domain controller."
      },
      "defaultValue": "2019-Datacenter"
    },
    "JumpServerVMImageSKU": {
      "type": "string",
      "allowedValues": [
        "2012-R2-Datacenter",
        "2016-Datacenter",
        "2019-Datacenter"
      ],
      "metadata": {
        "description": "Choose the OS type for the Jump Server."
      },
      "defaultValue": "2019-Datacenter"
    },
    "VirtualMachineSize": {
      "type": "string",
      "allowedValues": [
        "Standard_DS12_v2",
        "Standard_A2",
        "Standard_DS2_v2"
      ],
      "metadata": {
        "description": "VM Size. To increase the size of your Virtual Machines, pleast modify the template."
      },
      "defaultValue": "Standard_DS12_v2"
    }
  },
  "variables": {
    "_assetLocation": "https://github.com/chhatley/Azure/tree/master/Deploy%20ADDS%20Azure%20Solution/Deploy%20ADDS%20Azure%20Project",
    "VirtualMachineSize": "[parameters('VirtualMachineSize')]",
    "DC1VMOSVersion": "[parameters('DC1VMImageSKU')]",
    "DC2VMOSVersion": "[parameters('DC2VMImageSKU')]",
    "JumpserverVMOSVersion": "[parameters('JumpServerVMImageSKU')]",
    "VirtualNetworkAddressRange": "172.16.0.0/16",
    "FrontendNetworkSubnet": "172.16.1.0/24",
    "BackendNetworkSubnet": "172.16.2.0/24",
    "PrimaryDC1IpAddress": "172.16.1.4",
    "PrimaryDC2IpAddress": "172.16.1.5",
    "PrimaryJumpServerIpAddress": "172.16.2.4",
    "vNetTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/vNetDeployment.json')]",
    "NSGTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/NSGDeployment.json')]",
    "PublicIPTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/publicIP.json')]",
    "DC1TemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/DC1VMTemplate.json')]",
    "DC2TemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/DC2VMTemplate.json')]",
    "JumpServerTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/JumpServerVM.json')]",
    "DeployPrimaryAdTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/DeployPrimaryAD.json')]",
    "DeployDC2AdTemplateURL": "[concat(variables('_assetLocation'),'/LinkedTemplates/PromoteSecondDC.json')]",
    "DNSPrefix": "[tolower(concat(resourceGroup().name,'jump'))]",
    "DC1VmDeployment": "CreateADDC1VM",
    "DC1VmDeploymentId": "[concat('Microsoft.Resources/deployments/', variables('dc1VmDeployment'))]",
    "DC1VMName": "[parameters('DC1 Hostname')]",
    "DC2VmDeployment": "CreateADDC2VM",
    "DC2VmDeploymentId": "[concat('Microsoft.Resources/deployments/', variables('dc2VmDeployment'))]",
    "DC2VMName": "[parameters('DC2 Hostname')]",
    "JumpVMName": "[parameters('T0 Jump Server Hostname')]",
    "DeployVNet": "DeployVNet",
    "DeployVNetId": "[concat('Microsoft.Resources/deployments/', variables('deployVNet'))]",
    "DeployNSGs": "DeployNSGs",
    "DeployNSGsId": "[concat('Microsoft.Resources/deployments/', variables('deployNSGs'))]",
    "DeployPrimaryAD": "ConfigureAD",
    "DeployPrimaryADId": "[concat('Microsoft.Resources/deployments/', variables('deployPrimaryAd'))]",
    "DeployDC2AD": "ConfigureADDC2",
    "DeployDC2ADId": "[concat('Microsoft.Resources/deployments/', variables('deployDC2Ad'))]",
    "UpdateVNetDNS1": "UpdateVNetDNS",
    "UpdateVNetDNS2": "UpdateVNetDNS2",
    "vNetwithDNSTemplateURL": "[concat(variables('_assetLocation'),'/data/vNetDNSupdate.json')]",
    "JumpVMDeployment": "CreateJumpBoxVM",
    "JumpVMDeploymentId": "[concat('Microsoft.Resources/deployments/', variables('jumpVmDeployment'))]",
    "ADAvailabilitySetName": "[parameters('T0 AD Availability Set Name')]",
    "ImageOffer": "WindowsServer",
    "ImagePublisher": "MicrosoftWindowsServer",
    "PublicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
    "PubliclbID": "[resourceId('Microsoft.Network/loadBalancers',variables('publicLBName'))]",
    "PubliclbFEConfigID": "[concat(variables('publiclbID'),'/frontendIPConfigurations/',variables('lbFE'))]",
    "ADRDPNATRuleID": "[concat(variables('PublicLBID'),'/inboundNatRules/',variables('RDPNAT'))]",
    "DeployPublicIP": "DeployPublicIP",
    "DeployPublicIPId": "[concat('Microsoft.Resources/deployments/', variables('deployPublicIP'))]",
    "PublicLBName": "[parameters('T0 Public Load Balancer Name')]",
    "PublicIPAddressName": "[concat('ADlbPublicIP',resourceGroup().name)]",
    "LBFE": "[concat('ADLBFE',resourceGroup().name)]",
    "RDPNAT": "[concat('ADRDPNAT',resourceGroup().name)]",
    "RDPPort": "3389",
    "BENSGName": "[concat('BackEndADNSG',resourceGroup().name)]",
    "BENSGid": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('FENSGName'))]",
    "FENSGName": "[concat('FrontEndADNSG',resourceGroup().name)]",
    "FENSGID": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('FENSGName'))]",
    "DC1NICName": "[concat('DC1Nic',resourceGroup().name)]",
    "DC2NICName": "[concat('DC2Nic',resourceGroup().name)]",
    "JumpNICName": "[concat('T0JumpBoxNic',resourceGroup().name)]",
    "VirtualNetworkName": "[parameters('T0 AD vNet Name')]",
    "vNetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('VirtualNetworkName'))]",
    "BackendSubnetName": "[concat('BackEndADSubnet',resourceGroup().name)]",
    "BackendSubnetID": "[concat(variables('vNetID'),'/subnets/',variables('BackendSubnetName'))]",
    "FrontendSubnetName": "[concat('FrontEndADSubnet',resourceGroup().name)]",
    "FrontendSubnetID": "[concat(variables('vNetID'),'/subnets/',variables('FrontendSubnetName'))]",
    "Subnets": {
      "name": "[variables('backendSubnetName')]",
      "properties": {
        "addressPrefix": "[variables('backendNetworkSubnet')]",
        "networkSecurityGroup": {
          "id": "[variables('beNSGID')]"
        }
      }
    },
    {
      "name": "[variables('FrontendSubnetName')]",
      "properties": {
        "addressPrefix": "[variables('FrontendNetworkSubnet')]",
        "networkSecurityGroup": {
          "id": "[variables('FENSGID')]"
        }
      }
    },
    ]
  },
  "resources": [
    {
      "name": "[variables('ADAvailabilitySetName')]",
      "type": "Microsoft.Compute/availabilitySets",
      "apiVersion": "2017-03-30",
      "location": "[resourceGroup().location]",
      "properties": {
        "PlatformUpdateDomainCount": 3,
        "PlatformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "name": "[variables('DeployNSGs')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('NSGTemplateURL')]"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('VirtualNetworkName')]"
          },
          "subnets": {
            "value": "[ variables('Subnets')]"
          },
          "vNetID": {
            "value": "[variables('vNetID')]"
          },
          "beNSGName": {
            "value": "[variables('BENSGName')]"
          },
          "feNSGName": {
            "value": "[variables('FENSGName')]"
          },
          "beSubnetName": {
            "value": "[variables('BackendSubnetName')]"
          },
          "feSubnetName": {
            "value": "[variables('FrontendSubnetName')]"
          },
          "beSubnetId": {
            "value": "[variables('BackendSubnetID')]"
          },
          "feSubnetId": {
            "value": "[variables('FrontendSubnetID')]"
          },
          "sourceClientIP": {
            "value": "[parameters('SourceClientIP')]"
          }
        }
      }
    },
    {
      "name": "[variables('DeployVNet')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('DeployNSGsId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vNetTemplateURL')]"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('VirtualNetworkName')]"
          },
          "subnets": {
            "value": "[ variables('Subnets') ]"
          },
          "virtualNetworkAddressRange": {
            "value": "[variables('VirtualNetworkAddressRange')]"
          }
        }
      }
    },
    {
      "name": "[variables('DeployPublicIP')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('deployVNetId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('PublicIPTemplateURL')]"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('VirtualNetworkName')]"
          },
          "subnets": {
            "value": "[ variables('Subnets') ]"
          },
          "virtualNetworkAddressRange": {
            "value": "[variables('VirtualNetworkAddressRange')]"
          },
          "publicIPAddressName": {
            "value": "[variables('PublicIPAddressName')]"
          },
          "dnsPrefix": {
            "value": "[variables('DNSPrefix')]"
          },
          "publicLBName": {
            "value": "[variables('PublicLBName')]"
          },
          "lbFE": {
            "value": "[variables('LBFE')]"
          },
          "rdpNAT": {
            "value": "[variables('RDPNAT')]"
          },
          "rdpPort": {
            "value": "[variables('rdpPort')]"
          }
        }
      }
    },
    {
      "name": "[variables('DC1VmDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/availabilitySets',variables('adAvailabilitySetName'))]",
        "[variables('deployVNetId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('DC1TemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('AdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('AdminPassword')]"
          },
          "subnetResourceID": {
            "value": "[variables('BackendSubnetID')]"
          },
          "windowsImageSKU": {
            "value": "[variables('DC1VMOSVersion')]"
          },
          "vmName": {
            "value": "[variables('DC1VMName')]"
          },
          "vmSize": {
            "value": "[variables('VirtualMachineSize')]"
          },
          "adDNicName": {
            "value": "[variables('DC1NICName')]"
          },
          "primaryAdIpAddress": {
            "value": "[variables('PrimaryDC1IpAddress')]"
          },
          "adAvailabilitySetName": {
            "value": "[variables('ADAvailabilitySetName')]"
          }
        }
      }
    },
    {
      "name": "[variables('DeployPrimaryAD')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('dc1VmDeploymentId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('DeployPrimaryAdTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dc1VMName": {
            "value": "[variables('DC1VMName')]"
          },
          "domainName": {
            "value": "[parameters('DomainName')]"
          },
          "adminUsername": {
            "value": "[parameters('AdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('AdminPassword')]"
          },
          "assetLocation": {
            "value": "[variables('_assetLocation')]"
          }
        }
      }
    },
    {
      "name": "[variables('DC2VmDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('UpdateVNetDNS1')]",
        "[resourceId('Microsoft.Compute/availabilitySets',variables('adAvailabilitySetName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('DC2TemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('AdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('AdminPassword')]"
          },
          "subnetResourceID": {
            "value": "[variables('BackendSubnetID')]"
          },
          "windowsImageSKU": {
            "value": "[variables('DC2VMOSVersion')]"
          },
          "vmName": {
            "value": "[variables('DC2VMName')]"
          },
          "vmSize": {
            "value": "[variables('VirtualMachineSize')]"
          },
          "NicName": {
            "value": "[variables('DC2NICName')]"
          },
          "assetLocation": {
            "value": "[variables('_assetLocation')]"
          },
          "primaryIpAddress": {
            "value": "[variables('PrimaryDC2IpAddress')]"
          },
          "domainName": {
            "value": "[parameters('DomainName')]"
          },
          "adAvailabilitySetName": {
            "value": "[variables('ADAvailabilitySetName')]"
          }
        }
      }
    },
    {
      "name": "[variables('DeployDC2AD')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('DC2VmDeploymentId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('DeployDC2AdTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dc2VMName": {
            "value": "[variables('DC2VMName')]"
          },
          "domainName": {
            "value": "[parameters('DomainName')]"
          },
          "adminUsername": {
            "value": "[parameters('AdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('AdminPassword')]"
          },
          "assetLocation": {
            "value": "[variables('_assetLocation')]"
          }
        }
      }
    },
    {
      "name": "[variables('UpdateVNetDNS1')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('DeployPrimaryADId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vNetwithDNSTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('VirtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[variables('VirtualNetworkAddressRange')]"
          },
          "subnets": {
            "value": "[variables('Subnets')]"
          },
          "dnsServerAddress": {
            "value": [
              "[variables('PrimaryDC1IpAddress')]"
            ]
          }
        }
      }
    },
    {
      "name": "[variables('UpdateVNetDNS2')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('DeployPrimaryAdId')]",
        "[variables('DeployDC2AdId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vNetwithDNSTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('VirtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[variables('VirtualNetworkAddressRange')]"
          },
          "subnets": {
            "value": "[variables('subnets')]"
          },
          "dnsServerAddress": {
            "value": [
              "[variables('PrimaryDC1IpAddress')]",
              "[variables('PrimaryDC2IpAddress')]"
            ]
          }
        }
      }
    },
    {
      "name": "[variables('JumpVmDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('DeployPublicIPId')]",
        "[variables('UpdateVNetDNS1')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('JumpServerTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('AdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('AdminPassword')]"
          },
          "subnetResourceID": {
            "value": "[variables('FrontendSubnetID')]"
          },
          "windowsImageSKU": {
            "value": "[variables('JumpserverVMOSVersion')]"
          },
          "vmName": {
            "value": "[variables('JumpVMName')]"
          },
          "vmSize": {
            "value": "[variables('VirtualMachineSize')]"
          },
          "jumpNicName": {
            "value": "[variables('JumpNICName')]"
          },
          "primaryIpAddress": {
            "value": "[variables('PrimaryJumpServerIpAddress')]"
          },
          "domainName": {
            "value": "[parameters('DomainName')]"
          },
          "adRDPNATRuleID": {
            "value": "[variables('ADRDPNATRuleID')]"
          },
          "publicLBName": {
            "value": "[variables('PublicLBName')]"
          },
          "lbFE": {
            "value": "[variables('LBFE')]"
          },
          "rpdNAT": {
            "value": "[variables('RDPNAT')]"
          }
        }
      }
    }
  ],
  "outputs": {
  }
}
